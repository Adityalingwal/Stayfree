import { app, Tray, Menu, nativeImage, BrowserWindow } from 'electron';

// Webpack entry point declarations (auto-generated by Forge's Webpack plugin)
declare const MAIN_WINDOW_WEBPACK_ENTRY: string;
declare const MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY: string;

// Handle creating/removing shortcuts on Windows when installing/uninstalling.
if (require('electron-squirrel-startup')) {
  app.quit();
}

let tray: Tray | null = null;
let settingsWindow: BrowserWindow | null = null;

// --- App State ---
type AppState = 'idle' | 'recording' | 'processing';
let currentState: AppState = 'idle';

// --- Tray Icon Creation (programmatic SVG -> nativeImage) ---

function createTrayIcon(state: AppState): Electron.NativeImage {
  const size = 32;

  // Colors: idle=gray, recording=red, processing=orange
  const color = state === 'idle' ? '#666666' : state === 'recording' ? '#FF3B30' : '#FF9500';

  // Inner shape: idle=mic circle, recording=stop square, processing=triangle
  let innerShape = '';
  if (state === 'idle') {
    innerShape = '<circle cx="16" cy="16" r="6" fill="white" />';
  } else if (state === 'recording') {
    innerShape = '<rect x="11" y="11" width="10" height="10" rx="2" fill="white" />';
  } else {
    innerShape = '<polygon points="13,10 13,22 23,16" fill="white" />';
  }

  const svg = `<svg width="${size}" height="${size}" xmlns="http://www.w3.org/2000/svg">
    <circle cx="16" cy="16" r="14" fill="${color}" />
    ${innerShape}
  </svg>`;

  const dataUrl = `data:image/svg+xml;base64,${Buffer.from(svg).toString('base64')}`;
  return nativeImage.createFromDataURL(dataUrl);
}

function updateTrayState(state: AppState): void {
  currentState = state;
  if (tray) {
    tray.setImage(createTrayIcon(state));
    tray.setToolTip(
      state === 'idle' ? 'StayFree - Ready (Hold Fn to dictate)'
        : state === 'recording' ? 'StayFree - Recording...'
        : 'StayFree - Processing...'
    );
  }
}

// Export for use by other modules later
export { updateTrayState, currentState };
export type { AppState };

// --- Context Menu ---

function buildContextMenu(): Menu {
  return Menu.buildFromTemplate([
    {
      label: `StayFree v${app.getVersion()}`,
      enabled: false,
    },
    { type: 'separator' },
    {
      label: 'Paste Last Transcript',
      accelerator: 'Ctrl+Cmd+V',
      click: () => {
        // TODO: Phase 6 - paste last transcript functionality
        console.log('[StayFree] Paste last transcript clicked');
      },
    },
    { type: 'separator' },
    {
      label: 'Settings...',
      accelerator: 'Cmd+,',
      click: () => {
        openSettingsWindow();
      },
    },
    { type: 'separator' },
    {
      label: 'Quit StayFree',
      accelerator: 'Cmd+Q',
      click: () => {
        app.quit();
      },
    },
  ]);
}

// --- Settings Window ---

function openSettingsWindow(): void {
  if (settingsWindow) {
    settingsWindow.focus();
    return;
  }

  settingsWindow = new BrowserWindow({
    width: 480,
    height: 520,
    title: 'StayFree Settings',
    resizable: false,
    minimizable: false,
    maximizable: false,
    fullscreenable: false,
    show: false,
    webPreferences: {
      preload: MAIN_WINDOW_PRELOAD_WEBPACK_ENTRY,
    },
  });

  settingsWindow.loadURL(MAIN_WINDOW_WEBPACK_ENTRY);

  settingsWindow.once('ready-to-show', () => {
    settingsWindow.show();
  });

  settingsWindow.on('closed', () => {
    settingsWindow = null;
  });
}

// --- App Lifecycle ---

app.on('ready', () => {
  // Hide dock icon on macOS - this is a tray-only app
  if (process.platform === 'darwin') {
    app.dock.hide();
  }

  // Create system tray
  tray = new Tray(createTrayIcon('idle'));
  tray.setContextMenu(buildContextMenu());
  tray.setToolTip('StayFree - Ready (Hold Fn to dictate)');

  console.log('[StayFree] Running in system tray. Right-click tray icon for menu.');
});

// Tray app: keep running when all windows closed
app.on('window-all-closed', () => {
  // Do nothing - app lives in tray, not in windows
});

app.on('before-quit', () => {
  if (tray) {
    tray.destroy();
    tray = null;
  }
});
